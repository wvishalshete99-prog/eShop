
# azure-pipelines-enable-maintenance.yml
# Maintenance – Enable (asks for Resource Names + CRQ/SR/INC). Includes a "Next" confirmation screen.

trigger: none
pr: none

parameters:
  - name: resourceNames
    displayName: Azure resource name(s) (comma-separated)
    type: string
    default: ''
  - name: referenceId
    displayName: Reference Change Request [CRQ], Service Request [SR], or Incident [INC] ID
    type: string
    default: ''

variables:
  azureServiceConnection: 'REPLACE_WITH_AZURE_SERVICE_CONNECTION'
  tagMaintenanceKey: 'MaintenanceMode'
  tagChangeRefKey: 'ChangeRef'

stages:
  - stage: ValidateInputs
    displayName: Validate Inputs
    jobs:
      - job: Validate
        pool: { vmImage: 'ubuntu-latest' }
        steps:
          - script: |
              echo "Validating inputs for ENABLE maintenance..."
              if [ -z "$(resourceNames)" ]; then
                echo "ERROR: Please provide at least one Azure resource name."
                exit 1
              fi
              RESOURCES=$(echo "$(resourceNames)" | sed 's/ //g')
              if [ -z "$RESOURCES" ]; then
                echo "ERROR: Resource names cannot be empty after trimming."
                exit 1
              fi
              REF="$(referenceId)"
              if ! echo "$REF" | grep -Eiq '^(CRQ|SR|INC)'; then
                echo "ERROR: Reference ID must start with CRQ / SR / INC (e.g., CRQ00012345)."
                exit 1
              fi
              echo "✅ All validations passed."
            displayName: Validate parameter formats

          - task: ManualValidation@0
            displayName: "Next: Proceed to ENABLE maintenance"
            inputs:
              instructions: |
                Review and click 'Resume' to proceed:
                • Action: ENABLE
                • Resource Names: $(resourceNames)
                • Reference ID: $(referenceId)
              onTimeout: 'reject'
              timeout: '0'

  - stage: ApplyMaintenance
    displayName: Enable maintenance (tag resources)
    dependsOn: ValidateInputs
    condition: succeeded()
    jobs:
      - job: TagResources
        pool: { vmImage: 'ubuntu-latest' }
        steps:
          - task: AzureCLI@2
            displayName: Azure login
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: echo "Logged in to Azure."

          - task: AzureCLI@2
            displayName: Find and tag resources
            inputs:
              azureSubscription: $(azureServiceConnection)
