
# azure-pipelines-enable-maintenance.yml
# Maintenance – Enable (asks for Resource Names + CRQ/SR/INC). Includes a "Next" confirmation screen.

trigger: none
pr: none

# -------------------------
# Parameters (descriptive labels)
# -------------------------
parameters:
  - name: resourceNames
    # Descriptive label: tells users what to enter + format
    displayName: "Azure resource name(s) — enter exact names, comma-separated (no spaces). Example: er-gw-01,vpn-gw-02,vm-nw-03"
    type: string
    default: ''
  - name: referenceId
    # Descriptive label: explains CRQ/SR/INC with examples
    displayName: "Reference ID — approved Change/Service/Incident (must start with CRQ/SR/INC). Examples: CRQ00012345 or SR00056789 or INC00098765"
    type: string
    default: ''

# -------------------------
# Variables (set your service connection)
# -------------------------
variables:
  azureServiceConnection: 'REPLACE_WITH_AZURE_SERVICE_CONNECTION'  # e.g., Vodafone-Networks-Staging-SC
  tagMaintenanceKey: 'MaintenanceMode'
  tagChangeRefKey: 'ChangeRef'

stages:
  # 1) Validate the inputs
  - stage: ValidateInputs
    displayName: Validate Inputs
    jobs:
      - job: Validate
        displayName: Validate parameters
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "Validating inputs for ENABLE maintenance..."
              echo "Tip: You can copy the exact resource name from the Azure Portal > Resource > Overview."

              if [ -z "$(resourceNames)" ]; then
                echo "ERROR: Please provide at least one Azure resource name."
                echo "Example input: er-gw-01,vpn-gw-02,vm-nw-03"
                exit 1
              fi

              # Trim spaces and ensure not empty
              RESOURCES=$(echo "$(resourceNames)" | sed 's/ //g')
              if [ -z "$RESOURCES" ]; then
                echo "ERROR: Resource names cannot be empty after trimming spaces."
                echo "Example input: er-gw-01,vpn-gw-02,vm-nw-03"
                exit 1
              fi

              REF="$(referenceId)"
              if ! echo "$REF" | grep -Eiq '^(CRQ|SR|INC)'; then
                echo "ERROR: Reference ID must start with CRQ / SR / INC (e.g., CRQ00012345)."
                exit 1
              fi

              echo "✅ All validations passed."
            displayName: Validate parameter formats

          # "Next" button behavior — manual confirmation with friendly guidance
          - task: ManualValidation@0
            displayName: "Next: Review details and proceed to ENABLE maintenance"
            inputs:
              instructions: |
                Please review the details below. Click **Resume** to proceed or **Reject** to cancel.

                **Action:** ENABLE maintenance  
                **Azure resource name(s):** $(resourceNames)  
                **Reference ID (CRQ/SR/INC):** $(referenceId)

                ---
                **How to enter resource names**
                • Enter the **exact names** as seen in Azure Portal (Resource > Overview)  
                • Separate multiple names with commas (no spaces).  
                • Example: `er-gw-01,vpn-gw-02,vm-nw-03`

                **What happens next**
                • Each listed resource will be tagged with `MaintenanceMode=ON` and `ChangeRef=$(referenceId)`  
                • A summary of updated resources will be printed.  
                • If any names do not match an existing resource, they will be listed as “Not found”.

              onTimeout: 'reject'
              timeout: '0'  # no timeout

  # 2) Apply maintenance tags
  - stage: ApplyMaintenance
    displayName: Enable maintenance (tag resources)
    dependsOn: ValidateInputs
    condition: succeeded()
    jobs:
      - job: TagResources
        displayName: Tag/Un-tag resources
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: Azure login
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Azure login successful."

          - task: AzureCLI@2
            displayName: Locate resources and set MaintenanceMode=ON + ChangeRef
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail

                TAG_MAINT_KEY="$(tagMaintenanceKey)"
                TAG_REF_KEY="$(tagChangeRefKey)"
                REF="$(referenceId)"

                # Split the comma-separated names into an array, removing whitespace
                IFS=',' read -ra NAMES <<< "$(echo "$(resourceNames)" | tr -d '[:space:]')"

                echo "Searching for resources by exact name across the subscription..."
                FOUND_IDS=()
                NOT_FOUND=()

                for NAME in "${NAMES[@]}"; do
                  IDS=$(az resource list --name "$NAME" --query "[].id" -o tsv || true)
                  if [ -z "$IDS" ]; then
                    echo "⚠️  Not found: $NAME"
                    NOT_FOUND+=("$NAME")
                  else
                    while IFS= read -r ID; do
                      [ -z "$ID" ] && continue
                      FOUND_IDS+=("$ID")
                      echo "Found: $ID"
                    done <<< "$IDS"
                  fi
                done

                if [ ${#FOUND_IDS[@]} -eq 0 ]; then
                  echo "❌ No matching resources were found for the names you entered."
                  echo "Tip: Verify the exact names in Azure Portal (Resource > Overview) and try again."
                  exit 1
                fi

                echo "Applying tags: ${TAG_MAINT_KEY}=ON and ${TAG_REF_KEY}=${REF}"
                for ID in "${FOUND_IDS[@]}"; do
                  az resource update --ids "$ID" --set "tags.${TAG_MAINT_KEY}=ON" "tags.${TAG_REF_KEY}=${REF}"
                  echo "✅ Tagged: $ID  (${TAG_MAINT_KEY}=ON, ${TAG_REF_KEY}=${REF})"
                done

                echo "---- Summary ----"
                echo "Action       : ENABLE"
                echo "Reference ID : $REF"
                echo "Updated      : ${#FOUND_IDS[@]} resource(s)"
                if [ ${#NOT_FOUND[@]} -gt 0 ]; then
                  echo "Not found    : ${NOT_FOUND[*]}"
                fi

                echo "Done."
