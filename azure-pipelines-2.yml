
# azure-pipelines.yml
# Parameter order: Action (top), then Reference ID, then resource inputs.
# Labels updated with attention markers; validation outputs show red text in logs.

trigger: none
pr: none

parameters:
  - name: maintenanceAction
    displayName: "Action for maintenance (choose one): Enable or Disable"
    type: string
    default: Enable
    values:
      - Enable
      - Disable

  - name: referenceId
    displayName: "Reference ID — approved Change/Service/Incident (must start with CRQ/SR/INC). Examples: CRQ00012345, SR00056789, INC00098765"
    type: string
    default: ''

  - name: resourceNames
    displayName: "Azure resource name(s) — enter exact names, comma-separated (no spaces). Example: er-gw-01,vpn-gw-02,vm-nw-03  ⚠️ (Required only when Action=Enable)"
    type: string
    default: ''

  - name: excludeResourceNames
    displayName: "Exclude resource name(s) — comma-separated (no spaces). Example: er-gw-04,vm-nw-05  ⚠️ (Applies only when Action=Disable)"
    type: string
    default: ''

variables:
  azureServiceConnection: 'azureSubscriptionServiceConnection'
  tagMaintenanceKey: 'MaintenanceMode'
  tagChangeRefKey: 'ChangeRef'

stages:
  - stage: ValidateInputs
    displayName: "Validate inputs"
    jobs:
      - job: Validate
        displayName: "Validate runtime parameters"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: none

          - script: |
              set -e

              # ANSI colors for log output
              RED='\033[0;31m'
              YELLOW='\033[1;33m'
              NC='\033[0m'  # No Color

              ACTION='${{ parameters.maintenanceAction }}'
              REF_ID='${{ parameters.referenceId }}'
              INCLUDE_RAW='${{ parameters.resourceNames }}'
              EXCLUDE_RAW='${{ parameters.excludeResourceNames }}'

              echo -e "Action..................: ${ACTION}"
              echo -e "Reference ID............: ${REF_ID}"
              echo -e "Include resources (raw).: ${INCLUDE_RAW}"
              echo -e "Exclude resources (raw).: ${EXCLUDE_RAW}\n"

              # --- Reference validation FIRST ---
              if [ -z "${REF_ID}" ]; then
                echo -e "${RED}ERROR: Reference ID is required.${NC}"
                exit 1
              fi
              case "${REF_ID}" in
                CRQ*|SR*|INC*)
                  ;;
                *)
                  echo -e "${RED}ERROR: Reference ID must start with CRQ / SR / INC.${NC}"
                  exit 1
                  ;;
              esac

              # Normalize comma lists by removing spaces
              INCLUDE="${INCLUDE_RAW// /}"
              EXCLUDE="${EXCLUDE_RAW// /}"

              # Duplicates across include & exclude are not allowed
              IFS=',' read -r -a incArr <<< "${INCLUDE}"
              IFS=',' read -r -a excArr <<< "${EXCLUDE}"
              for i in "${incArr[@]}"; do
                for e in "${excArr[@]}"; do
                  if [ -n "$i" ] && [ "$i" = "$e" ]; then
                    echo -e "${RED}ERROR: Resource '$i' appears in BOTH include and exclude.${NC}"
                    exit 1
                  fi
                done
              done

              case "${ACTION}" in
                Enable)
                  if [ -z "${INCLUDE}" ]; then
                    echo -e "${RED}ERROR: When Action=Enable, 'Azure resource name(s)' is required.${NC}"
                    exit 1
                  fi
                  if [ -n "${EXCLUDE}" ]; then
                    echo -e "${RED}ERROR: 'Exclude resource name(s)' applies only when Action=Disable.${NC}"
                    exit 1
                  fi
                  ;;

                Disable)
                  if [ -z "${INCLUDE}" ] && [ -z "${EXCLUDE}" ]; then
                    echo -e "${YELLOW}WARNING: Disable requested without include or exclude lists; this implies 'ALL resources'. Consider adding exclusions or confirm via approval stage.${NC}"
                  fi
                  ;;
                *)
                  echo -e "${RED}ERROR: Unknown Action '${ACTION}'.${NC}"
                  exit 1
                  ;;
              esac

              echo "Validation completed."
            displayName: "Validate & normalize inputs"

  - stage: ConfirmDisableAllExcept
    displayName: "Confirm Disable Maintenance – All Except"
    dependsOn: ValidateInputs
    condition: >
      and(
        eq('${{ parameters.maintenanceAction }}','Disable'),
        eq('${{ parameters.resourceNames }}',''),
        ne('${{ parameters.excludeResourceNames }}','')
      )
    jobs:
      - job: ManualApprove
        displayName: "Manual approval – confirm scope"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: ManualValidation@0
            displayName: "Confirm Disable Maintenance (ALL except exclusions)"
            inputs:
              notifyUsers: ''
              instructions: |
                You are about to perform: **Disable Maintenance**
                Scope: **ALL resources**
                Excluded resources: ${{ parameters.excludeResourceNames }}
                Reference ID: ${{ parameters.referenceId }}

                ⚠️ This will disable maintenance for all resources **except** the names listed above.
                Proceed only if the scope and exclusions are correct.
              onTimeout: 'reject'
              timeout: '1d'

  - stage: Execute
    displayName: "Execute maintenance action"
    dependsOn:
      - ValidateInputs
      - ConfirmDisableAllExcept
    condition: succeeded()
    jobs:
      - job: PlanScope
        displayName: "Resolve execution scope"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              set -e

              ACTION='${{ parameters.maintenanceAction }}'
              INCLUDE_RAW='${{ parameters.resourceNames }}'
              EXCLUDE_RAW='${{ parameters.excludeResourceNames }}'

              INCLUDE="${INCLUDE_RAW// /}"
              EXCLUDE="${EXCLUDE_RAW// /}"

              echo "Action: ${ACTION}"
              echo "Include: ${INCLUDE}"
              echo "Exclude: ${EXCLUDE}"
              echo

              mkdir -p out

              if [ "${ACTION}" = "Enable" ]; then
                echo "${INCLUDE}" | tr ',' '\n' | sed '/^$/d' > out/target_resources.txt
                echo "Plan: ENABLE maintenance for listed resources:"
                cat out/target_resources.txt

              else
                echo "${INCLUDE}" | tr ',' '\n' | sed '/^$/d' > out/include.txt
                echo "${EXCLUDE}" | tr ',' '\n' | sed '/^$/d' > out/exclude.txt

                if [ -s out/include.txt ] && ! [ -s out/exclude.txt ]; then
                  cp out/include.txt out/target_resources.txt
                  echo "Plan: DISABLE maintenance for listed resources (include only)."

                elif ! [ -s out/include.txt ] && [ -s out/exclude.txt ]; then
                  echo "NOTE: Implement discovery for ALL resources in scope and subtract exclusions."
                  # az account set --subscription "<your-subscription>"
                  # az resource list --query "[].name" -o tsv > out/all.txt
                  # grep -v -x -f out/exclude.txt out/all.txt > out/target_resources.txt

                else
                  grep -v -x -f out/exclude.txt out/include.txt > out/target_resources.txt
                  echo "Plan: DISABLE maintenance for include MINUS exclude."
                fi

                [ -f out/target_resources.txt ] && echo "Target resources:" && cat out/target_resources.txt || true
              fi
            displayName: "Build execution plan"

      - job: ExecuteAction
        displayName: "Apply maintenance action"
        dependsOn: PlanScope
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: "Login to Azure"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                echo "Logged in via service connection."

          - script: |
              set -e
              ACTION='${{ parameters.maintenanceAction }}'
              REF_ID='${{ parameters.referenceId }}'
              TAG_M_KEY='$(tagMaintenanceKey)'
              TAG_C_KEY='$(tagChangeRefKey)'

              if [ ! -f out/target_resources.txt ]; then
                echo "No target resources resolved; nothing to do."
                exit 0
              fi

              echo "Executing ${ACTION} for resources:"
              cat out/target_resources.txt || true
              echo

              while read -r NAME; do
                [ -z "${NAME}" ] && continue
                echo "Processing: ${NAME}"
                # RID resolution & tag updates go here
              done < out/target_resources.txt
            displayName: "Apply tags / maintenance state (example)"
